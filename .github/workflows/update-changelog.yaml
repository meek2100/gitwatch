name: Update Changelog on PR Merge

on:
  pull_request:
    types: [closed] # Trigger when a PR is closed
    branches:
      - master # Only when the target branch is master

permissions:
  contents: write # Needed to create/push branches and create PRs
  pull-requests: write # Needed to create a PR

jobs:
  update_changelog:
    # Only run if the PR was actually merged (not just closed)
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Get PR Details
        id: pr_details
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          PR_TITLE=${{ github.event.pull_request.title }}
          PR_AUTHOR=${{ github.event.pull_request.user.login }}
          # Simple format: "- PR Title (#Number) by @Author"
          CHANGELOG_ENTRY="- ${PR_TITLE} (#${PR_NUMBER}) by @${PR_AUTHOR}"
          echo "entry=${CHANGELOG_ENTRY}" >> $GITHUB_OUTPUT
          echo "branch_name=chore/changelog-pr-${PR_NUMBER}" >> $GITHUB_OUTPUT

      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          # Check out the master branch explicitly
          ref: master
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Create New Branch
        run: |
          git checkout -b ${{ steps.pr_details.outputs.branch_name }}

      - name: Configure Git User
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Update CHANGELOG.md
        run: |
          UNRELEASED_HEADER="## [Unreleased]"
          ESCAPED_UNRELEASED_HEADER="## \\[Unreleased\\]" # For grep/sed
          NEW_ENTRY="${{ steps.pr_details.outputs.entry }}"
          CHANGELOG_FILE="CHANGELOG.md"

          # Check if [Unreleased] section exists. If not, add it.
          if ! grep -q "^${ESCAPED_UNRELEASED_HEADER}$" "${CHANGELOG_FILE}"; then
            echo "'${UNRELEASED_HEADER}' section not found. Adding it."
            # Add the header and a newline right after the main title block (e.g., after line 3)
            # Use awk to insert after the first few lines (adjust line number if needed)
            awk 'NR==3{print "\n## [Unreleased]\n"} {print}' "${CHANGELOG_FILE}" > "${CHANGELOG_FILE}.tmp" && mv "${CHANGELOG_FILE}.tmp" "${CHANGELOG_FILE}"
            echo "Added '${UNRELEASED_HEADER}' section."
          fi

          # Now, insert the new entry directly below the [Unreleased] header
          # Use awk to find the header and print the entry after it
          awk -v header="$ESCAPED_UNRELEASED_HEADER" -v entry="$NEW_ENTRY" '
          BEGIN { inserted = 0 }
          { print } # Print the current line
          # If the current line matches the header AND we haven't inserted yet
          $0 == header && !inserted {
            print entry
            inserted = 1
          }
          ' "${CHANGELOG_FILE}" > "${CHANGELOG_FILE}.tmp"

          # Check if awk actually inserted the line (basic check: file size difference)
          if [ "$(wc -c < "${CHANGELOG_FILE}")" -eq "$(wc -c < "${CHANGELOG_FILE}.tmp")" ]; then
             echo "Warning: awk may not have inserted the entry. Header might be missing or duplicated."
          fi

          mv "${CHANGELOG_FILE}.tmp" "${CHANGELOG_FILE}"
          echo "Processed entry for CHANGELOG.md: ${NEW_ENTRY}"

      - name: Install Prettier
        run: |
          npm install -g prettier

      - name: Format CHANGELOG.md with Prettier
        run: |
          prettier --write CHANGELOG.md
          echo "Formatted CHANGELOG.md"

      - name: Commit and Push Updated Changelog to New Branch
        run: |
          git add CHANGELOG.md
          # Check if the changelog was actually modified
          if git diff --staged --quiet; then
            echo "No changes detected in CHANGELOG.md."
          else
            git commit -m "chore: Update CHANGELOG.md for PR #${{ github.event.pull_request.number }}"
            # Push to the new branch
            git push origin ${{ steps.pr_details.outputs.branch_name }}
          fi

      - name: Create Pull Request
        # Only run if the commit was actually pushed
        if: steps.commit_files.outputs.committed == 'true'
        uses: repo-sync/pull-request@v2
        with:
          source_branch: ${{ steps.pr_details.outputs.branch_name }}
          destination_branch: "master"
          pr_title: "chore: Update CHANGELOG.md for PR #${{ github.event.pull_request.number }}"
          pr_body: "Automated changelog update from #${{ github.event.pull_request.number }}."
          pr_reviewer: "${{ github.event.pull_request.user.login }}"
          token: ${{ secrets.GITHUB_TOKEN }}
