---
name: Gitwatch QA

on:
  push:
  pull_request:
    branches: [master]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  #-------------------------------------------------------------------------
  super-lint:
    name: Lint Code Base
    if: "! contains(github.event.head_commit.message, '#noaction')"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
    # For the time being, I'm giving up on Super Linter. It's a great tool,
    # but it's currently broken, and it's taking more time to make it work than
    # it's worth.
    # - name: Lint Code Base
    #   uses: github/super-linter@v4
    #   env:
    #     DEFAULT_BRANCH: master
    #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    #     # Linter is having errors at symbolic link, appears to be
    #     # this bug:
    #     # https://github.com/github/super-linter/issues/1400
    #     # https://github.com/kucherenko/jscpd/issues/481
    #     # Test files are bats files, which don't follow bash standards
    #     # FILTER_REGEX_EXCLUDE: \.github/linters/\.markdown-lint.yml | tests\.*
    #     # FILTER_REGEX_EXCLUDE: tests\.*

  #-------------------------------------------------------------------------
  bats:
    name: BATS Tests
    if: "! contains(github.event.head_commit.message, '#noaction')"
    strategy:
      matrix:
        os: [ubuntu-latest, macOS-latest]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 5

    steps:
      # Removed setup-node and npm install bats

      - name: Install OS-specific dependencies (inotify/fswatch, flock)
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            sudo apt-get -y update
            sudo apt-get -y install inotify-tools util-linux
          elif [ "$RUNNER_OS" == "macOS" ]; then
            brew install fswatch flock
          else
            echo "Unsupported OS: $RUNNER_OS"
            exit 1
          fi

      - name: Checkout code
        uses: actions/checkout@v4
        # Submodules no longer needed if removed from repo
        # with:
        #  fetch-depth: 0

      # Use bats-action to install bats and helpers
      - name: Setup Bats and helper libraries
        id: setup-bats
        uses: bats-core/bats-action@v3.0.1
        # Optional: Specify exact versions if needed
        with:
          bats-version: latest
          support-version: "0.3.0"
          assert-version: "2.2.4"
          file-version: "0.4.0"

      # Removed manual submodule initialization step

      # - name: Setup upterm session # Preserved commented-out step
      #   uses: lhotari/action-upterm@v1

      - name: Run tests individually
        shell: bash
        env:
          # Use the library path output from the bats-action step
          BATS_LIB_PATH: ${{ steps.setup-bats.outputs.lib-path }}
        run: |
          git config --global user.email "test@email.com"
          git config --global user.name "test user"

          cd tests

          echo "Running commitcmd.bats..."
          bats commitcmd.bats
          echo "Running commitlog.bats..."
          bats commitlog.bats
          echo "Running notify-ignore.bats..."
          bats notify-ignore.bats
          echo "Running pull-rebase.bats..."
          bats pull-rebase.bats
          echo "Running remotedirs.bats..."
          bats remotedirs.bats
          echo "Running spaces.bats..."
          bats spaces.bats
          echo "Running status-change.bats..."
          bats status-change.bats
          echo "Running sync.bats..."
          bats sync.bats
          echo "Finished running tests"
