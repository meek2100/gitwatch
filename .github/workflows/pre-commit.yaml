---
name: pre-commit
on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:

permissions: {}

jobs:
  pre-commit:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      RAW_LOG: pre-commit.log
      SKIP: no-commit-to-branch
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          persist-credentials: false
      - run: python -m pip install pre-commit regex
      - uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830
        with:
          path: ~/.cache/pre-commit/
          key:
            pre-commit-4|${{ env.pythonLocation }}|${{ hashFiles('.pre-commit-config.yaml')
            }}
      - name: Run pre-commit hooks
        id: precommit_run
        continue-on-error: true
        run: |
          set -o pipefail
          pre-commit gc

          # Run command and tee to log
          pre-commit run --show-diff-on-failure --color=always --all-files | tee "${RAW_LOG}"

          # Verification is now separate from the command
          echo "--- Verifying ${RAW_LOG} content IN SAME STEP ---"
          if [ -f "${RAW_LOG}" ]; then
            echo "File found. Contents:"
            ls -l "${RAW_LOG}"
            cat "${RAW_LOG}"
          else
            echo "File ${RAW_LOG} NOT FOUND."
          fi
          echo "--- End of verification ---"

      - name: Generate pre-commit Summary
        if: always()
        shell: bash
        run: |
          echo "--- Verifying ${RAW_LOG} exists before processing ---"
          if [ ! -f "${RAW_LOG}" ]; then
            echo "Raw log file (${RAW_LOG}) NOT FOUND."
            echo "Raw log file (${RAW_LOG}) NOT FOUND." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          echo "File found. Proceeding with perl."

          # Strip ANSI color codes
          perl -pe 's/\e\[[0-9;]*m//g' "${RAW_LOG}" > clean_log.log

          echo "--- Verifying clean_log.log exists ---"
          if [ ! -f "clean_log.log" ]; then
            echo "Clean log file (clean_log.log) was NOT created by perl."
            echo "Clean log file (clean_log.log) was NOT created by perl." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          echo "Clean log file found. Proceeding with awk."

          # --- FIXED AWK SCRIPT ---
          # This script now robustly finds the status as the last word
          # and treats everything before the dots as the hook name.
          AWK_SCRIPT=$(cat << 'EOF'
          BEGIN {
              print "### Pre-commit Hook Results"
              print ""
              print "| Hook | Status |"
              print "| --- | --- |"
              passed = 0
              failed = 0
              skipped = 0
              had_failures = "false"
          }
          # Match lines with the dots and a status at the end
          # e.g., "Hook Name.................Passed"
          # e.g., "Hook Name.................(no files to check)Skipped"
          /(\.+)(Passed|Failed|Skipped)$/ {
              status = $NF

              hook_name = $0
              # Remove the status word from the end
              sub(/(Passed|Failed|Skipped)$/, "", hook_name)
              # Remove the "(no files to check)" part
              sub(/\(no files to check\)$/, "", hook_name)
              # Remove the trailing dots
              sub(/\.+\s*$/, "", hook_name)
              # Trim any other leading/trailing whitespace
              gsub(/^[ \t]+|[ \t]+$/, "", hook_name)

              if (status == "Passed") {
                  print "| ✅ " hook_name " | Passed |"
                  passed++
              } else if (status == "Failed") {
                  print "| ❌ " hook_name " | Failed |"
                  failed++
                  had_failures = "true"
              } else if (status == "Skipped") {
                  print "| ⏩ " hook_name " | Skipped |"
                  skipped++
              }
          }
          END {
              print ""
              print "---"
              print "**Summary:** " passed " passed, " failed " failed, " skipped " skipped."
              print "::set-output name=overall_failed::" had_failures
          }
          EOF
          )

          AWK_OUTPUT=$(awk "$AWK_SCRIPT" clean_log.log)

          echo "$AWK_OUTPUT" >> $GITHUB_STEP_SUMMARY

          OVERALL_FAILED_FLAG=$(echo "$AWK_OUTPUT" | grep "^::set-output name=overall_failed::" | cut -d':' -f4)

          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "$OVERALL_FAILED_FLAG" == "true" ]; then
              echo ":red_circle: **Overall Status: Hooks Failed**" >> $GITHUB_STEP_SUMMARY
              exit 1
          else
              echo ":white_check_mark: **Overall Status: All Hooks Passed**" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Provide log as artifact
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4
        if: ${{ ! cancelled() }}
        with:
          name: precommit-logs
          path: "${{ env.RAW_LOG }}"
          retention-days: 2
