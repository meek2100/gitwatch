---
name: Windows E2E Functional Test

on:
  push:
  pull_request:
    branches: [master]
  workflow_dispatch:

permissions: {}

jobs:
  windows-e2e-test:
    name: Windows E2E Functional Test
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          persist-credentials: false

      - name: Substitute Version Number into gitwatch.sh
        shell: bash
        run: |
          VERSION_NUMBER=$(cat VERSION)
          sed -i "s/%%GITWATCH_VERSION%%/${VERSION_NUMBER}/g" gitwatch.sh
          echo "Substituted version ${VERSION_NUMBER} into gitwatch.sh for testing."

      - name: Run Windows Installer
        shell: powershell
        run: |
          # The installer needs all 3 files in the same directory
          # We need to copy gitwatch.sh into the examples/windows directory for the test
          Copy-Item -Path ".\gitwatch.sh" -Destination ".\examples\windows\gitwatch.sh" -Force

          # Run the installer script with Administrator privileges
          Start-Process powershell -Verb RunAs -ArgumentList "-File .\examples\windows\install.ps1"

          # Wait for the installer to finish and PATH to propagate
          Write-Host "Waiting 30 seconds for installer and PATH to propagate..."
          Start-Sleep -Seconds 30

      - name: Verify gitwatch.bat --version
        shell: powershell
        run: |
          # Reload the environment to get the new PATH
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
          Write-Host "Updated PATH: $env:Path"
          Write-Host "Verifying gitwatch.bat is in PATH..."
          Get-Command gitwatch.bat
          Write-Host "Running gitwatch.bat --version..."
          gitwatch.bat --version

      - name: Run Windows functional test
        shell: powershell
        run: |
          # 1. Setup Test Repo
          $testDir = "C:\gitwatch-test-dir"
          $logFile = "C:\gitwatch.log"
          $errFile = "C:\gitwatch.err"
          if (Test-Path $testDir) { Remove-Item $testDir -Recurse -Force }
          mkdir $testDir
          git -C $testDir init
          git -C $testDir config user.email "test@example.com"
          git -C $testDir config user.name "CI Test"
          echo "init" | Out-File "$testDir\testfile.txt"
          git -C $testDir add .
          git -C $testDir commit -m "Initial commit"
          $initialHash = git -C $testDir log -1 --format=%H
          Write-Host "Initial hash: $initialHash"

          # 2. Start gitwatch.bat
          Write-Host "Starting gitwatch.bat in background..."
          # Start the process and log output
          Start-Process -FilePath "gitwatch.bat" -ArgumentList "-v, $testDir" -NoNewWindow -RedirectStandardOutput $logFile -RedirectStandardError $errFile
          Write-Host "Waiting 5 seconds for gitwatch to start..."
          Start-Sleep -Seconds 5

          # 3. Trigger Change
          Write-Host "Triggering file change..."
          echo "new line" | Add-Content "$testDir\testfile.txt"
          Write-Host "Waiting 10 seconds for commit to happen (debounce 2s + commit time)..."
          Start-Sleep -Seconds 10

          # 4. Verify Result
          Write-Host "Checking for new commit..."
          $finalHash = git -C $testDir log -1 --format=%H
          Write-Host "Final hash: $finalHash"

          Write-Host "--- gitwatch.log ---"
          Get-Content $logFile -ErrorAction SilentlyContinue
          Write-Host "--- gitwatch.err ---"
          Get-Content $errFile -ErrorAction SilentlyContinue

          # 5. Stop Process
          Write-Host "Cleaning up... (Stopping wsl processes)"
          $wslProcess = Get-Process -Name "wsl" -ErrorAction SilentlyContinue
          if ($wslProcess) { Stop-Process -Name "wsl" -Force -ErrorAction SilentlyContinue }
          $wslService = Get-Process -Name "wslservice" -ErrorAction SilentlyContinue
          if ($wslService) { Stop-Process -Name "wslservice" -Force -ErrorAction SilentlyContinue }

          # 6. Final Assertion
          if ($initialHash -eq $finalHash) {
            Write-Error "Commit hash did not change. Test failed."
            exit 1
          } else {
            Write-Host "New commit detected. Test passed!"
          }

      - name: Cleanup Test Files
        if: always()
        shell: powershell
        run: |
          Remove-Item "C:\gitwatch-test-dir" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item "C:\gitwatch.log" -ErrorAction SilentlyContinue
          Remove-Item "C:\gitwatch.err" -ErrorAction SilentlyContinue
