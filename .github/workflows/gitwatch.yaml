---
name: Gitwatch QA

on:
  push:
  pull_request:
    branches: [master]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

permissions: {}

jobs:
  #-------------------------------------------------------------------------
  bats:
    name: BATS Tests
    if: "!contains(github.event.head_commit.message, '#noaction')"
    permissions:
      contents: read
      # Allow writing artifacts
      actions: write
    strategy:
      matrix:
        os: [ubuntu-latest, macOS-latest]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10

    steps:
      - name: Reusable Setup (Checkout, BATS, Version)
        uses: ./.github/workflows/reusable-setup.yaml
        id: setup
        with:
          os: ${{ matrix.os }}
          setup-bats: true

      - name: Install gitwatch OS dependencies
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            sudo apt-get update
            sudo apt-get -y install inotify-tools util-linux
          elif [ "$RUNNER_OS" == "macOS" ]; then
            brew install fswatch flock coreutils bash
          else
            echo "Unsupported OS: $RUNNER_OS"
            exit 1
          fi

      # - name: Setup upterm session # Preserved commented-out step
      #   uses: lhotari/action-upterm@v1

      - name: Install kcov (for coverage on Linux)
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get -y install kcov

      - name: Display gitwatch.sh content before testing
        shell: bash
        run: |
          echo "--- Displaying gitwatch.sh from $(pwd) ---"
          cat gitwatch.sh
          echo "--- End of gitwatch.sh ---"

      - name: Verify script content before test
        shell: bash
        run: |
          echo "--- Verifying gitwatch.sh content ---"
          # Verify the git write-tree check
          grep -C 3 'if \[ "$staged_tree_hash" = "$head_tree_hash" \];' gitwatch.sh
          echo "--- Verifying debounce logic (PID File Method) ---"
          # Verify the start of the new debounce logic block using the PID file
          grep -C 3 'if \[ -f "$TIMER_PID_FILE" \];' gitwatch.sh
          echo "--- End of verification ---"

      - name: Run tests (and coverage on Linux)
        shell: bash
        # Set BATS_LIB_PATH to include action-installed libraries and our custom module
        env:
          BATS_LIB_PATH: "${{ steps.setup.outputs.bats-lib-path }}:${{ github.workspace }}/tests"
        run: |
          git config --global user.email "test@email.com"
          git config --global user.name "test user"

          cd tests

          # Get the number of available processor cores
          NPROC=1
          if [ "$RUNNER_OS" == "Linux" ]; then
            NPROC=$(nproc)
          elif [ "$RUNNER_OS" == "macOS" ]; then
            NPROC=$(sysctl -n hw.ncpu)
          fi

          echo "Running BATS tests in parallel using $NPROC cores..."

          if [ "$RUNNER_OS" == "Linux" ]; then
            # Run with kcov on Linux
            echo "Running with kcov for code coverage..."
            mkdir -p ../coverage
            # We must run kcov from the root of the repo to get correct paths
            cd ..
            # kcov manages its own parallel execution, but we point it to the bats files
            # Note: kcov + BATS can be complex. This command runs all tests under one kcov instance.
            # We use `find` to pass all test files to `bats` at once.
            kcov --include-path=./ --bash-parser=./gitwatch.sh coverage/ bats $(find tests -name "*.bats")
          else
            # Run normally on macOS
            # Use find and xargs to pipe test files to bats
            # -n1: one file at a time per bats process
            # -P $NPROC: run up to $NPROC processes in parallel
            # We add --tap to get a standard output format, which is good for parallel runs
            find . -name "*.bats" -print0 | xargs -0 -n1 -P "$NPROC" bats --tap
          fi

          echo "Finished running tests"

      - name: Upload coverage report (Linux)
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-linux
          path: coverage/
          retention-days: 7
