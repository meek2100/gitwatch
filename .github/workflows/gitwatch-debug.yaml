---
name: Gitwatch QA (Sequential Debug)

on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

permissions: {}

jobs:
  #-------------------------------------------------------------------------
  bats:
    name: BATS Tests
    if: "!contains(github.event.head_commit.message, '#noaction')"
    permissions:
      contents: read
      # Allow writing artifacts
      actions: write
    strategy:
      # Fail-fast is false so you can see failures on both OSs
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macOS-latest]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10

    steps:
      - name: Checkout Repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          persist-credentials: false

      - name: Reusable Setup (Checkout, BATS, Version)
        uses: ./.github/actions/setup
        id: setup
        with:
          os: ${{ matrix.os }}
          setup-bats: true

      - name: Cache apt packages (Linux)
        if: matrix.os == 'ubuntu-latest'
        uses: actions/cache@v4
        with:
          path: /var/cache/apt
          key: ${{ runner.os }}-apt-${{ hashFiles('**/gitwatch.yaml') }}
          restore-keys: |
            ${{ runner.os }}-apt-

      - name: Cache brew packages (macOS)
        if: matrix.os == 'macOS-latest'
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/Homebrew
          key: ${{ runner.os }}-brew-${{ hashFiles('**/gitwatch.yaml') }}
          restore-keys: |
            ${{ runner.os }}-brew-

      - name: Install gitwatch OS dependencies
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            sudo apt-get update
            sudo apt-get -y install inotify-tools util-linux
          elif [ "$RUNNER_OS" == "macOS" ]; then
            brew install fswatch flock coreutils bash
          else
            echo "Unsupported OS: $RUNNER_OS"
            exit 1
          fi

      # - name: Setup upterm session # Preserved commented-out step
      #   uses: lhotari/action-upterm@v1

      # Note: The 'Install kcov' step has been removed from here.
      # It is now inside .github/actions/setup/action.yaml

      - name: Display gitwatch.sh content before testing
        shell: bash
        run: |
          echo "--- Displaying gitwatch.sh from $(pwd) ---"
          cat gitwatch.sh
          echo "--- End of gitwatch.sh ---"

      - name: Verify script content before test
        shell: bash
        run: |
          echo "--- Verifying gitwatch.sh content ---"
          # Verify the git write-tree check
          grep -C 3 'if \[ "$staged_tree_hash" = "$head_tree_hash" \];' gitwatch.sh
          echo "--- Verifying debounce logic (PID File Method) ---"
          # Verify the start of the new debounce logic block using the PID file
          grep -C 3 'if \[ -f "$TIMER_PID_FILE" \];' gitwatch.sh
          echo "--- End of verification ---"

      - name: Run BATS tests (one-by-one)
        shell: bash
        # Set BATS_LIB_PATH to include action-installed libraries and our custom module
        env:
          BATS_LIB_PATH: "${{ steps.setup.outputs.bats-lib-path }}:${{ github.workspace }}/tests"
        run: |
          git config --global user.email "test@email.com"
          git config --global user.name "test user"

          cd tests

          echo "===================================================================="
          echo "Running BATS tests sequentially."
          echo "Uncomment the 'bats ...' lines below to run them one-by-one."
          echo "===================================================================="

          # --- UNCOMMENT TESTS ONE-BY-ONE TO DEBUG ---
          # We use --tap for clean, standardized output

          # bats --tap add-failure.bats ## (Fail)
          # bats --tap atomic-file.bats ## (Fail)
          # bats --tap backoff.bats ## (Fail)
          # bats --tap bash-compatibility.bats ## (Fail)
          # bats --tap case.bats ## (Fail)
          # bats --tap commitcmd.bats ## (Fail)
          # bats --tap commitlog.bats ## (Fail)
          # bats --tap commitmsg-unit.bats ## (Fail)
          # bats --tap custom-bins.bats ## (Fail)
          # bats --tap custom-events.bats ## (Fail)
          # bats --tap debounce.bats ## (Fail)
          # bats --tap dependency-failure.bats ## (Fail)
          # bats --tap diff-lines.bats ## (Fail)
          # bats --tap docker.bats ## (Fail)
          # bats --tap git-command-failure.bats ## (Fail)
          # bats --tap git-config-failure.bats ## (Fail)
          # bats --tap glob-conversion.bats ## (Fail)
          # bats --tap helpers.bats ## (Fail)
          # bats --tap hook-failure.bats ## (Fail)
          # bats --tap large-file.bats ## (NEW)
          # bats --tap lfs.bats ## (Fail)
          # bats --tap lockfile-fallback.bats ## (Fail)
          # bats --tap lockfile-nohash.bats ## (Fail)
          # bats --tap lockfile-race.bats ## (Fail)
          # bats --tap lockfile-success.bats ## (Fail)
          # bats --tap logging-levels.bats ## (Fail)
          # bats --tap notify-ignore.bats ## (Fail)
          # bats --tap perm-check.bats ## (Fail)
          # bats --tap pull-norebase-conflict.bats ## (Fail)
          # bats --tap pull-rebase.bats ## (Fail)
          # bats --tap quiet.bats ## (Fail)
          # bats --tap remotedirs.bats ## (Fail)
          # bats --tap signal-handling.bats ## (Fail)
          # bats --tap skip-merging.bats ## (Fail)
          # bats --tap spaces.bats ## (Fail)
          # bats --tap special-chars.bats ## (Fail)
          # bats --tap startup-options.bats ## (Fail)
          # bats --tap status-change.bats ## (Fail)
          # bats --tap submodule.bats ## (Fail)
          # bats --tap symlinks.bats ## (Fail)
          # bats --tap sync.bats ## (Fail)
          # bats --tap syslog.bats ## (Fail)
          # bats --tap target-deletion.bats ## (Fail)
          # bats --tap timeout.bats ## (Fail)
          bats --tap watcher-args.bats ## (Fail)

          echo "===================================================================="
          echo "Finished running tests."
          echo "===================================================================="

      # Note: The 'Upload coverage report (Linux)' step is removed
      # as kcov is not being run in this sequential setup.

}
