<!-- Generated by github-markdown-toc -->

<!-- gh-md-toc --insert README.md -->

<!-- markdownlint-disable -->

<!--ts-->

- [gitwatch](#gitwatch)
  - [What to use it for?](#what-to-use-it-for)
  - [Installation](#installation)
    - [From Source](#from-source)
    - [Releases](#releases)
      - [Update](#update)
    - [bpkg](#bpkg)
    - [Archlinux](#archlinux)
    - [NixOS](#nixos)
      - [As Module](#as-module)
      - [As Package](#as-package)
  - [Docker](#docker)
    - [Docker Compose (Recommended)](#docker-compose-recommended)
    - [Using the Dockerfile](#using-the-dockerfile)
  - [Requirements](#requirements)
    - [Notes for Mac](#notes-for-mac)
  - [Local Testing](#local-testing)
  - [What it does](#what-it-does)
  - [Usage](#usage)
    - [Security Considerations](#security-considerations)
    - [Behavior Notes](#behavior-notes)
    - [Advanced Environment Variables (non-Docker)](#advanced-environment-variables-non-docker)
    - [Starting on Boot](#starting-on-boot)
      - [SysVInit](#sysvinit)
      - [systemd](#systemd)
  - [Other Articles](#other-articles)
    - [On the Gitwatch Wiki](#on-the-gitwatch-wiki)
    - [Community Articles](#community-articles)

<!-- Added by: harleypig, at: Sun Mar  7 03:39:32 PM MST 2021 -->

<!--te-->

<!-- markdownlint-enable -->

# gitwatch

[![Gitwatch QA](https://github.com/gitwatch/gitwatch/actions/workflows/gitwatch.yaml/badge.svg)](https://github.com/gitwatch/gitwatch/actions/workflows/gitwatch.yaml)
[![GitHub release (latest by date)](https://img.shields.io/github/v/release/gitwatch/gitwatch)](https://github.com/gitwatch/gitwatch/releases/latest)
[![Docker Image](https://img.shields.io/badge/ghcr.io-gitwatch%2Fgitwatch-blue)](https://github.com/gitwatch/gitwatch/pkgs/container/gitwatch)

A Bash script to watch a file or folder and commit changes to a Git
repository

## What to use it for?

That's really up to you, but here are some examples:

- **config files**: some programs auto-write their config files, without
  waiting for you to click an 'Apply' button; or even if there is such a
  button, most programs offer you no way of going back to an earlier
  version of your settings. If you commit your config file(s) to a Git
  repository, you can track changes and go back to older versions. This
  script makes it convenient, to have all changes recorded automatically.
- **document files**: if you use an editor that does not have built-in Git
  support (or maybe if you don't like the Git support it has), you can use
  gitwatch to automatically commit your files when you save them, or
  combine it with the editor's auto-save feature to fully automatically and
  regularly track your changes
- _more stuff!_ If you have any other uses, or can think of ones, please
  let us know, and we can add them to this list!

## Installation

`gitwatch` can be installed in various ways.

### From Source

`gitwatch` can be installed from source by simply cloning the repository
and putting the shell script into your `$PATH`. The commands below will do
that for you if `/usr/local/bin` is in your `$PATH`. You may need to invoke
`install` with `sudo`.

```sh
git clone https://github.com/gitwatch/gitwatch.git
cd gitwatch
[sudo] install -b gitwatch.sh /usr/local/bin/gitwatch
```

### Releases

For the most stable version, you can download the `gitwatch.sh` script
directly from the project's
[GitHub Releases page](https://github.com/gitwatch/gitwatch/releases/latest).

This is a simple way to get the latest tagged script without cloning the
entire repository. A common way to install it is to download it directly
into your local bin path:

```sh
# Download the latest version to /usr/local/bin (you may need sudo)
curl -L -o /usr/local/bin/gitwatch [https://github.com/gitwatch/gitwatch/releases/latest/download/gitwatch.sh](https://github.com/gitwatch/gitwatch/releases/latest/download/gitwatch.sh)

# Make it executable
chmod +x /usr/local/bin/gitwatch
```

#### Update

If you installed `gitwatch` from source, you can update it by following the
exact same steps (or `git pull` rather than clone if you kept the
repository around).

### bpkg

`gitwatch` can be installed with [bpkg](https://github.com/bpkg/bpkg). Make
sure you have [bpkg](https://github.com/bpkg/bpkg) installed before running
the command below. You may need to invoke `bpkg` with `sudo` when using the
`-g` flag.

```sh
[sudo] bpkg install -g gitwatch/gitwatch
```

### Archlinux

There is an [AUR](https://aur.archlinux.org/packages/gitwatch-git/) package
for Archlinux. Install it with you favorite aur helper.

### NixOS

Starting from NixOS 24.11 this package available in mainline. Additionally,
you can use receipts from this repository.

#### As Module

Each watching path should be described in _submodule_ `services.gitwatch.*`
like next:

```nix
services.gitwatch.<service name> = {
    enable = true;
    path = "/home/me/my-repo";
    remote = "git@github.com:me/my-repo.git";
    user = "me";
    message = "Auto-commit by gitwatch on %d";
};
```

This will make NixOS to create `systemd` service named
`gitwatch-<service name>`. More details you can see at
`man configuration.nix`.

#### As Package

The `gitwatch` script available as package in _nixpkgs_;

## Docker

You can also run `gitwatch` inside a Docker container. This is useful for
isolating dependencies and ensuring a consistent environment.

### Docker Compose (Recommended)

The easiest way to run `gitwatch` with Docker is by using the provided
`docker-compose.yml` file.

**1. Prerequisites:**

- **Docker and Docker Compose**: Make sure you have both installed.
  - [Install Docker](https://docs.docker.com/get-docker/)
  - [Install Docker Compose](https://docs.docker.com/compose/install/)
- **A Git Repository**: You need a local directory that is a Git repository
  you want to watch.
- **SSH Key**: For pushing to a remote repository, the container needs
  access to an SSH key that is authorized with your Git provider.

**2. Configuration:**

The `docker-compose.yml` file is configured using environment variables.
You can either edit the `environment` section directly in the file or
create a `.env` file in the same directory to set the values.

Here's a breakdown of the important parts of the `docker-compose.yml` file:

- **`volumes`**: This is the most critical section to configure.
  - `./watched-repo:/app/watched-repo`: This maps a directory from your
    computer (the "host") into the container.
    - You **must** change `./watched-repo` to the path of the local Git
      repository you want `gitwatch` to monitor.
  - `~/.ssh/id_ed25519:/root/.ssh/id_ed25519:ro`: This securely mounts your
    SSH private key (e.g., `id_ed25519` or `id_rsa`) into the container in
    read-only mode (`ro`). This is necessary for `gitwatch` to push changes
    to your remote repository.
  - `~/.gitconfig:/root/.gitconfig:ro`: This mounts your Git configuration
    into the container. This ensures that the commits made by `gitwatch`
    are attributed to you with the correct name and email.
- **`environment`**: This section controls how `gitwatch` behaves.
  <!-- prettier-ignore-start -->
  **3. Environment Variables**

The following environment variables are available for configuring the
`gitwatch` container:

| Variable            | Default Value          | Description                                                                                                                       |
| :------------------ | :--------------------- | :-------------------------------------------------------------------------------------------------------------------------------- |
| `PUID`              | `1000`                 | **Optional.** Sets the User ID (UID) for the container's non-root user to match the host user, preventing file permission issues. |
| `PGID`              | `(blank)`              | **Optional but Recommended.** Sets the Group ID (GID) for the container's user. Run `id -g` on your host to find this value.      |
| `GIT_WATCH_DIR`     | `/app/watched-repo`    | The directory inside the container to watch for changes. This must match the container path you set in the `volumes` section.     |
| `GIT_REMOTE`        | `origin`               | The name of the remote repository to push to.                                                                                     |
| `GIT_BRANCH`        | `main`                 | The branch to push to.                                                                                                            |
| `GIT_EXTERNAL_DIR`  | `""`                   | Use with the `-g` flag (e.g., `/app/.git`) to specify an external Git directory.                                                  |
| `PULL_BEFORE_PUSH`  | `"false"`              | Set to `"true"` to run `git pull --rebase` before every push (`-R`).                                                              |
| `SLEEP_TIME`        | `2`                    | Time in seconds to wait after a file change before committing (`-s`).                                                             |
| `COMMIT_MSG`        | `"Auto-commit: %d"`    | The commit message format (`-m`). Ignored if `COMMIT_CMD` is set.                                                                 |
| `DATE_FMT`          | `"+%Y-%m-%d %H:%M:%S"` | The date format used in the commit message (`-d`).                                                                                |
| `COMMIT_CMD`        | `""`                   | Custom shell command to generate the entire commit message (`-c`). Overrides `COMMIT_MSG`.                                        |
| `PASS_DIFFS`        | `"false"`              | Set to `"true"` to pipe the list of changed files to `COMMIT_CMD` (`-C`).                                                         |
| `EVENTS`            | `""`                   | Events passed to the underlying watcher tool (`-e`). Uses platform defaults if empty.                                             |
| `EXCLUDE_PATTERN`   | `""`                   | A comma-separated list of glob patterns to exclude from monitoring (`-X`).                                                        |
| `RAW_EXCLUDE_REGEX` | `""`                   | A raw regex pattern to exclude from monitoring (`-x`).                                                                            |
| `SKIP_IF_MERGING`   | `"false"`              | Set to `"true"` to prevent commits when a merge is in progress (`-M`).                                                            |
| `COMMIT_ON_START`   | `"false"`              | Set to `"true"` to commit any pending changes on startup (`-f`).                                                                  |
| `VERBOSE`           | `"false"`              | Set to `"true"` to enable verbose output for debugging (`-v`).                                                                    |
| `USE_SYSLOG`        | `"false"`              | Set to `"true"` to log all messages to syslog (`-S`).                                                                             |

<!-- prettier-ignore-end -->

**4. Running gitwatch:**

- **Start the container** in the background (detached mode):

  ```sh
  docker-compose up -d
  ```

- **View the logs** to see what `gitwatch` is doing:

  ```sh
  docker-compose logs -f
  ```

- **Stop the container**:

  ```sh
  docker-compose down
  ```

### Using the Dockerfile

If you prefer to build the Docker image yourself, you can use the provided
`Dockerfile`. This is useful if you want to customize the image with
additional tools or dependencies.

**1. Build the image:**

From the root of the `gitwatch` repository, run:

```sh
docker build -t gitwatch .
```

**2. Run the container:**

To run the container, you need to provide the same volumes and environment
variables as the Docker Compose setup.

```sh
docker run -d \
    --name gitwatch \
    -v /path/to/your/repo:/app/watched-repo \
    -v ~/.ssh/id_rsa:/root/.ssh/id_rsa:ro \
    -v ~/.gitconfig:/root/.gitconfig:ro \
    -e GIT_WATCH_DIR="/app/watched-repo" \
    -e GIT_REMOTE="origin" \
    -e GIT_BRANCH="main" \
    gitwatch
```

**Important:** Remember to replace `/path/to/your/repo` with the actual
path to the Git repository you want to watch.

## Requirements

To run this script, you must have installed and globally available:

- `git` ([Git](https://github.com/git/git) |
  [git-scm](http://www.git-scm.com))
- **File Watcher:** Either `inotifywait` (part of
  **[inotify-tools](https://github.com/rvoicilas/inotify-tools)**, for
  Linux) or `fswatch` (for macOS/BSD).
- **Locking (Highly Recommended):** `flock` (part of `util-linux` on most
  Linux distributions) for process locking and debouncing.
- **Timeout (Required):** `timeout` (part of `coreutils` on most
  Linux/macOS distributions) for robust Git operations.

The script automatically detects the appropriate watcher tool based on your
operating system.

### Notes for Mac

If running on macOS, you'll need to install the required runtime tools and
the **BATS testing framework** via Homebrew:

```sh
# Runtime Dependencies
brew install fswatch flock coreutils
```

```sh
# Testing Dependencies (Required to run .bats files locally)
# bats-core and its helper libraries are now explicitly required.
brew install bats-core bats-support bats-assert bats-file
```

## Local Testing

This project uses [BATS](https://github.com/bats-core/bats-core) for
testing. The easiest way to run the full test suite is by using the
provided `Makefile`.

1.  **Install Dependencies**: Follow the instructions in `CONTRIBUTING.md`
    to install the runtime and testing dependencies (like
    `bats-core`, `shellcheck`, etc.).

2.  **Install Hooks**: Install the `pre-commit` hooks, which will ensure all
    linting passes before you commit.

    ```sh
    pre-commit install
    ```

3.  **Run Tests**:
    ```sh
    make test
    ```

## What it does

When you start the script, it first performs critical checks:

1. **Permission Check:** Verifies the user has read/write/execute
   permissions on the target directory and the `.git` directory.
2. **Locking Check:** Attempts to acquire a non-blocking process lock using
   `flock` to prevent multiple instances from running concurrently on the
   same repository.
3. **Optional Startup Commit:** If the `-f` flag is provided, it commits
   any pending staged changes before starting the watch loop.

Then it enters the main loop, which runs forever (until forcefully
stopped/killed), where it:

- **Watches for changes** using `inotifywait` (Linux) or `fswatch` (macOS),
  which block until an event occurs.
- **Debounces changes** for the configured `SLEEP_TIME` (default 2
  seconds). The advanced debounce logic is PID-file-based and kills
  outdated commit timers when new changes arrive, ensuring only one commit
  runs for a rapid burst of changes.
- **Stages changes:**
  - Case file: `git add <file>`
  - Case directory: `git add --all .`
- **Avoids empty commits:** It compares the staged file tree with the HEAD
  file tree. If only metadata (like file timestamps) has changed, the
  commit is skipped, and any spurious index entries are unstaged with
  `git reset --mixed`.
- **Commits changes:**
  `git commit -m "Scripted auto-commit on change (<date>)"`
- **Optional Pull/Push:** If a remote is defined (`-r`):
  - If `-R` is used, it runs `git pull --rebase <remote>` before pushing.
  - It then pushes to the configured remote/branch (`-b`).

Notes:

- The debouncing mechanism handles rapid, consecutive changes robustly,
  ensuring one successful commit per burst.
- `gitwatch` includes graceful shutdown handling (`INT`, `TERM`) and
  automatic cleanup of lockfiles and timer PIDs via `trap`.
- Repositories are always watched recursively by default when a directory
  is the target.

## Usage

The general usage syntax is:

```sh
gitwatch.sh [-s <secs>] [-t <secs>] [-d <fmt>] [-r <remote> [-b <branch> | -R]] \
    [-g <path>] [-m <msg>] [-l | -L <lines>] [-x <pattern>] [-X <glob/list>] \
    [-c <command> [-C]] [-M] [-S] [-v] [-f] [-V] <target>
```

Where `<target>` is the file or folder to be watched.

| Option | Argument      | Default                | Description                                                                                                                        |
| :----- | :------------ | :--------------------- | :--------------------------------------------------------------------------------------------------------------------------------- |
| `-s`   | `<secs>`      | `2`                    | **Debounce Delay.** Time to wait after a change before initiating the commit process.                                              |
| `-t`   | `<secs>`      | `60`                   | **Git Timeout.** Timeout in seconds for critical Git operations (commit, pull, push).                                              |
| `-d`   | `<fmt>`       | `"+%Y-%m-%d %H:%M:%S"` | **Date Format.** Format string for the timestamp (`%d`) in the commit message (see `man date`).                                    |
| `-r`   | `<remote>`    | _None_                 | **Push Remote.** Specifies a remote to push to after every successful commit.                                                      |
| `-R`   | _None_        | _None_                 | **Pull/Rebase.** If used with `-r`, performs a `git pull --rebase` before the push.                                                |
| `-b`   | `<branch>`    | _Current_              | **Target Branch.** Specifies the branch to push to.                                                                                |
| `-g`   | `<path>`      | _None_                 | **Git Dir.** Specifies the path to an external `.git` directory (`--git-dir`).                                                     |
| `-l`   | `<lines>`     | `-1`                   | **Log Changes (Color).** Includes diff lines in the commit message, up to `<lines>` count (use `0` for unlimited).                 |
| `-L`   | `<lines>`     | `-1`                   | **Log Changes (Plain).** Same as `-l` but without colored formatting.                                                              |
| `-m`   | `<msg>`       | `"Auto-commit: %d"`    | **Commit Message.** Template for the commit message. Ignored if `-c` is used.                                                      |
| `-c`   | `<command>`   | _None_                 | **Custom Message Command.** Command to run to generate the full commit message. Overrides `-m`, `-d`, `-l`, and `-L`.              |
| `-C`   | _None_        | _None_                 | **Pipe Diff.** If used with `-c`, pipes the list of changed files (`git diff --staged --name-only`) to the custom command's stdin. |
| `-e`   | `<events>`    | _OS Default_           | **Watcher Events.** Custom event list for `inotifywait` or `fswatch`.                                                              |
| `-x`   | `<pattern>`   | _None_                 | **Exclude Regex.** Raw regex pattern to exclude files/directories from being monitored. The `.git` folder is always excluded.      |
| `-X`   | `<glob/list>` | _None_                 | **Exclude Globs.** Comma-separated list of glob patterns to exclude (e.g., `*.log,tmp/`). Converted to regex.                      |
| `-M`   | _None_        | _None_                 | **Skip Merging.** Prevents commits if a Git merge/rebase is currently in progress.                                                 |
| `-f`   | _None_        | _None_                 | **Commit on Start.** Commits any pending staged changes before starting the watch loop.                                            |
| `-S`   | _None_        | _None_                 | **Syslog.** Logs all messages to syslog (daemon mode) instead of stdout/stderr.                                                    |
| `-v`   | _None_        | _None_                 | **Verbose.** Enables verbose logging for debugging (`set -x` if not using syslog).                                                 |
| `-V`   | _None_        | _None_                 | **Version.** Prints version information and exits.                                                                                 |

### Security Considerations

**Arbitrary Code Execution via `-c`**

The `-c` (custom command) flag is a powerful feature that executes
arbitrary shell commands. This is by design, but it carries inherent
security risks, especially if `gitwatch` is run as a privileged user or in
an environment where the repository content (which could be pulled from a
remote) is not fully trusted.

**Warning:** Only use the `-c` flag with trusted commands. Never run
`gitwatch` as root if watching a repository that could be modified by
untrusted users.

### Behavior Notes

- **Repository Requirement:** The watched file or directory must already be
  part of a Git repository.
- **Automatic Staging:** For a file target, only the file is staged
  (`` `git add <file>` ``). For a directory target, all changes (adds,
  modifications, deletions) in the directory are staged recursively
  (`` `git add --all .` ``).
- **Empty Commit Prevention:** `gitwatch` prevents commits if only metadata
  (like timestamps) has changed, ensuring only meaningful file content or
  file count changes result in a new commit.

### Advanced Environment Variables (non-Docker)

For advanced use cases (e.g., running from source or via systemd), you can
override default script behavior using environment variables:

- `GW_GIT_BIN`: Specify the full path to the `git` binary.
- `GW_INW_BIN`: Specify the full path to the watcher binary (`inotifywait`
  or `fswatch`).
- `GW_FLOCK_BIN`: Specify the full path to the `flock` binary.
- `GW_TIMEOUT`: Overrides the default 60-second timeout for Git operations.
- `GW_READ_TIMEOUT`: Overrides the auto-detected event drain timeout (e.g.,
  `0.1` or `1`).
- `GW_LOG_LINE_LENGTH`: Overrides the default 150-character truncation for
  lines in the `-l`/`-L` commit log.

### Starting on Boot

If you want to have the script auto-started upon boot, the method to do
this depends on your operating system and distribution.

Please also note that if either of the paths involved (script or target)
contains spaces or special characters, you need to escape them accordingly.

#### SysVInit

A central place to put startup scripts on Linux is generally
`/etc/rc.local`. This file, if it has the +x bit, will be executed upon
startup, **by the root user account**. If you want to start `gitwatch` from
`rc.local`, the recommended way to call it is:

<!-- markdownlint-disable -->

`su -c "/absolute/path/to/script/gitwatch.sh /absolute/path/to/watched/file/or/folder" -l <username> &`

<!-- markdownlint-restore -->

The `<username>` bit should be replaced with your username or that of any
other (non-root) user account; it only needs write-access to the Git
repository of the file/folder you want to watch. The ampersand (`&`) at the
end sends the launched process into the background (this is important if
you have other calls in `rc.local` after the mentioned line, because the
`gitwatch` call does not usually return).

#### systemd

This service is designed to run in user space (`--user` flag).

- If installed to a path other than `/usr/local/bin/gitwatch`, modify the
  `ExecStart` path within `gitwatch@.service` to suit.
- Create the user systemd directory if it does not exist and copy the
  systemd service file:
  `mkdir -p "$HOME/.config/systemd/user" && cp gitwatch@.service $HOME/.config/systemd/user`
- Start and enable the service for a given path and arguments by running
  the following command. The arguments are passed to the service after
  being escaped.
  `systemctl --user --now enable gitwatch@$(systemd-escape -- "'-r url/to/repository' /path/to/folder").service`

## Other Articles

### On the Gitwatch Wiki

- [How to Install `Gitwatch` as a Debian Service With `supervisord`](https://github.com/gitwatch/gitwatch/wiki/gitwatch-as-a-service-on-Debian-with-supervisord)

### Community Articles

- [How To Use `Gitwatch` by Maisa Milena](https://medium.com/@maisa.milena/how-to-use-gitwatch-92c72e8ea4c4)
- [Syncing and Backing Up Your Thoughts with `Obsidian`, `Syncthing`, and `Gitwatch` by Vinícius Costa](https://viniciusnevescosta.medium.com/syncing-and-backing-up-your-thoughts-with-obsidian-syncthing-and-gitwatch-a55670b2b63f)
